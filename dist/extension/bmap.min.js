
/*
* Licensed to the Apache Software Foundation (ASF) under one
* or more contributor license agreements.  See the NOTICE file
* distributed with this work for additional information
* regarding copyright ownership.  The ASF licenses this file
* to you under the Apache License, Version 2.0 (the
* "License"); you may not use this file except in compliance
* with the License.  You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing,
* software distributed under the License is distributed on an
* "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
* KIND, either express or implied.  See the License for the
* specific language governing permissions and limitations
* under the License.
*/


!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("echarts")):"function"==typeof define&&define.amd?define(["exports","echarts"],e):e(t.bmap={},t.echarts)}(this,function(t,o){"use strict";function m(t,e){this._bmap=t,this.dimensions=["lng","lat"],this._mapOffset=[0,0],this._api=e,this._projection=new BMap.MercatorProjection}function n(a,r){return r=r||[0,0],o.util.map([0,1],function(t){var e=r[t],o=a[t]/2,n=[],i=[];return n[t]=e-o,i[t]=e+o,n[1-t]=i[1-t]=r[1-t],Math.abs(this.dataToPoint(n)[t]-this.dataToPoint(i)[t])},this)}var c;m.prototype.dimensions=["lng","lat"],m.prototype.setZoom=function(t){this._zoom=t},m.prototype.setCenter=function(t){this._center=this._projection.lngLatToPoint(new BMap.Point(t[0],t[1]))},m.prototype.setMapOffset=function(t){this._mapOffset=t},m.prototype.getBMap=function(){return this._bmap},m.prototype.dataToPoint=function(t){var e=new BMap.Point(t[0],t[1]),t=this._bmap.pointToOverlayPixel(e),e=this._mapOffset;return[t.x-e[0],t.y-e[1]]},m.prototype.pointToData=function(t){var e=this._mapOffset;return[(t=this._bmap.overlayPixelToPoint({x:t[0]+e[0],y:t[1]+e[1]})).lng,t.lat]},m.prototype.getViewRect=function(){var t=this._api;return new o.graphic.BoundingRect(0,0,t.getWidth(),t.getHeight())},m.prototype.getRoamTransform=function(){return o.matrix.create()},m.prototype.prepareCustoms=function(t){var e=this.getViewRect();return{coordSys:{type:"bmap",x:e.x,y:e.y,width:e.width,height:e.height},api:{coord:o.util.bind(this.dataToPoint,this),size:o.util.bind(n,this)}}},m.dimensions=m.prototype.dimensions,m.create=function(t,r){var p,s=r.getDom();t.eachComponent("bmap",function(t){var e=r.getZr().painter,o=e.getViewportRoot();if("undefined"==typeof BMap)throw new Error("BMap api is not loaded");function n(t){this._root=t}if(c=c||((n.prototype=new BMap.Overlay).initialize=function(t){return t.getPanes().labelPane.appendChild(this._root),this._root},n.prototype.draw=function(){},n),p)throw new Error("Only one bmap component can exist");t.__bmap||((a=s.querySelector(".ec-extension-bmap"))&&(o.style.left="0px",o.style.top="0px",s.removeChild(a)),(a=document.createElement("div")).style.cssText="width:100%;height:100%",a.classList.add("ec-extension-bmap"),s.appendChild(a),i=t.__bmap=new BMap.Map(a,{enableMapClick:!1}),a=new c(o),i.addOverlay(a),e.getViewportRootOffset=function(){return{offsetLeft:0,offsetTop:0}});var i=t.__bmap,o=t.get("center"),a=t.get("zoom");o&&a&&(e=new BMap.Point(o[0],o[1]),i.centerAndZoom(e,a)),(p=new m(i,r)).setMapOffset(t.__mapOffset||[0,0]),p.setZoom(a),p.setCenter(o),t.coordinateSystem=p}),t.eachSeries(function(t){"bmap"===t.get("coordinateSystem")&&(t.coordinateSystem=p)})},o.extendComponentModel({type:"bmap",getBMap:function(){return this.__bmap},setCenterAndZoom:function(t,e){this.option.center=t,this.option.zoom=e},centerOrZoomChanged:function(t,e){var o,n=this.option;return o=t,t=n.center,!(o&&t&&o[0]===t[0]&&o[1]===t[1]&&e===n.zoom)},defaultOption:{center:[104.114129,37.550339],zoom:5,mapStyle:{},roam:!1}}),o.extendComponentView({type:"bmap",render:function(n,t,i){var a=!0,e=n.getBMap(),r=i.getZr().painter.getViewportRoot(),p=n.coordinateSystem,o=function(t,e){var o;a||(o=r.parentNode.parentNode.parentNode,o=[-parseInt(o.style.left,10)||0,-parseInt(o.style.top,10)||0],r.style.left=o[0]+"px",r.style.top=o[1]+"px",p.setMapOffset(o),n.__mapOffset=o,i.dispatchAction({type:"bmapRoam"}))};function s(){a||i.dispatchAction({type:"bmapRoam"})}e.removeEventListener("moving",this._oldMoveHandler),e.removeEventListener("zoomend",this._oldZoomEndHandler),e.addEventListener("moving",o),e.addEventListener("zoomend",s),this._oldMoveHandler=o,this._oldZoomEndHandler=s;var m=n.get("roam");m&&"scale"!==m?e.enableDragging():e.disableDragging(),m&&"move"!==m?(e.enableScrollWheelZoom(),e.enableDoubleClickZoom(),e.enablePinchToZoom()):(e.disableScrollWheelZoom(),e.disableDoubleClickZoom(),e.disablePinchToZoom());var c=n.__mapStyle,o=n.get("mapStyle")||{},m=JSON.stringify(o);JSON.stringify(c)!==m&&(Object.keys(o).length&&e.setMapStyle(o),n.__mapStyle=JSON.parse(m)),a=!1}}),o.registerCoordinateSystem("bmap",m),o.registerAction({type:"bmapRoam",event:"bmapRoam",update:"updateLayout"},function(t,e){e.eachComponent("bmap",function(t){var e=t.getBMap(),o=e.getCenter();t.setCenterAndZoom([o.lng,o.lat],e.getZoom())})});t.version="1.0.0"});
